<!-- pages/session/edit/index.wxml -->
<view class="session-edit-page">
  <!-- è¡¨å•å®¹å™¨ -->
  <scroll-view scroll-y class="form-scroll" bindscrolltolower="onScroll">
    <view class="form-container">
      <!-- æ¥è®¿è€…é€‰æ‹© -->
      <view class="form-section">
        <view class="section-header">
          <view class="section-title">æ¥è®¿è€…ä¿¡æ¯</view>
          <view class="section-required">å¿…å¡«</view>
        </view>
        
        <view class="form-group" bindtap="onSelectClient">
          <view class="form-label">é€‰æ‹©æ¥è®¿è€…</view>
          <view class="picker-field {{selectedClient ? '' : 'placeholder'}}">
            {{selectedClient ? selectedClient.name : 'è¯·é€‰æ‹©æ¥è®¿è€…'}}
          </view>
          <view class="arrow-icon">â€º</view>
        </view>
        
        <!-- æ˜¾ç¤ºé€‰ä¸­çš„æ¥è®¿è€…ä¿¡æ¯ -->
        <view wx:if="{{selectedClient}}" class="selected-client-info">
          <view class="client-card">
            <view class="client-avatar">
              <text class="avatar-text">{{selectedClient.name.charAt(0)}}</text>
            </view>
            <view class="client-details">
              <view class="client-name">{{selectedClient.name}}</view>
              <view class="client-meta">
                <text>{{selectedClient.gender === 1 ? 'ç”·' : selectedClient.gender === 2 ? 'å¥³' : 'æœªçŸ¥'}}</text>
                <text wx:if="{{selectedClient.age}}"> {{selectedClient.age}}å²</text>
              </view>
              <view class="client-tags">
                <text wx:for="{{selectedClient.tags || []}}" wx:key="index" class="tag">{{item}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- å’¨è¯¢æ—¶é—´ -->
      <view class="form-section">
        <view class="section-header">
          <view class="section-title">å’¨è¯¢æ—¶é—´</view>
          <view class="section-required">å¿…å¡«</view>
        </view>
        
        <view class="form-group" bindtap="onSelectDate">
          <view class="form-label">æ—¥æœŸ</view>
          <view class="picker-field {{formData.sessionTime ? '' : 'placeholder'}}">
            {{formData.sessionTime ? formatDate(formData.sessionTime) : 'è¯·é€‰æ‹©æ—¥æœŸ'}}
          </view>
          <view class="arrow-icon">â€º</view>
        </view>
        
        <view class="form-group" bindtap="onSelectTime">
          <view class="form-label">å¼€å§‹æ—¶é—´</view>
          <view class="picker-field {{formData.startTime ? '' : 'placeholder'}}">
            {{formData.startTime ? formatTime(formData.startTime) : 'è¯·é€‰æ‹©æ—¶é—´'}}
          </view>
          <view class="arrow-icon">â€º</view>
        </view>
        
        <view class="form-group">
          <view class="form-label">æŒç»­æ—¶é—´</view>
          <view class="duration-picker">
            <view class="duration-btn {{formData.duration === 50 ? 'active' : ''}}" 
                  data-duration="50" bindtap="onSelectDuration">
              50åˆ†é’Ÿ
            </view>
            <view class="duration-btn {{formData.duration === 60 ? 'active' : ''}}" 
                  data-duration="60" bindtap="onSelectDuration">
              60åˆ†é’Ÿ
            </view>
            <view class="duration-btn custom-duration" bindtap="onCustomDuration">
              <input 
                type="number" 
                placeholder="è‡ªå®šä¹‰" 
                value="{{formData.duration !== 50 && formData.duration !== 60 ? formData.duration : ''}}"
                bindinput="onCustomDurationInput"
                bindblur="onDurationBlur"
              />
              <text class="unit">åˆ†é’Ÿ</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å’¨è¯¢è®¾ç½® -->
      <view class="form-section">
        <view class="section-header">
          <view class="section-title">å’¨è¯¢è®¾ç½®</view>
        </view>
        
        <view class="form-group">
          <view class="form-label">å’¨è¯¢ç±»å‹</view>
          <view class="radio-group">
            <view 
              wx:for="{{sessionTypes}}" 
              wx:key="id"
              class="radio-item {{formData.sessionType === item.id ? 'active' : ''}}"
              data-type="{{item.id}}"
              bindtap="onSelectSessionType"
            >
              <view class="radio-dot"></view>
              <text class="radio-text">{{item.name}}</text>
            </view>
          </view>
        </view>
        
        <view class="form-group">
          <view class="form-label">å’¨è¯¢æ–¹å¼</view>
          <view class="radio-group">
            <view 
              wx:for="{{sessionModes}}" 
              wx:key="id"
              class="radio-item {{formData.sessionMode === item.id ? 'active' : ''}}"
              data-mode="{{item.id}}"
              bindtap="onSelectSessionMode"
            >
              <view class="radio-dot"></view>
              <text class="radio-text">{{item.name}}</text>
            </view>
          </view>
        </view>
        
        <view class="form-group">
          <view class="form-label">å’¨è¯¢åœ°ç‚¹</view>
          <input 
            type="text" 
            class="form-input" 
            placeholder="è¯·è¾“å…¥å’¨è¯¢åœ°ç‚¹" 
            value="{{formData.location}}"
            bindinput="onLocationInput"
          />
        </view>
        
        <view class="form-group">
          <view class="form-label">å’¨è¯¢è´¹ç”¨</view>
          <view class="money-input">
            <text class="currency">Â¥</text>
            <input 
              type="digit" 
              class="money-input-field" 
              placeholder="0.00" 
              value="{{formData.fee}}"
              bindinput="onFeeInput"
            />
          </view>
        </view>
      </view>

      <!-- ç£å¯¼ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-header">
          <view class="section-title">
            ç£å¯¼ä¿¡æ¯
            <switch class="supervision-switch" checked="{{formData.hasSupervision}}" 
                    bindchange="onSupervisionToggle" />
          </view>
        </view>
        
        <view wx:if="{{formData.hasSupervision}}">
          <view class="form-group">
            <view class="form-label">ç£å¯¼ç±»å‹</view>
            <view class="radio-group">
              <view 
                wx:for="{{supervisionTypes}}" 
                wx:key="id"
                class="radio-item {{formData.supervisionType === item.id ? 'active' : ''}}"
                data-type="{{item.id}}"
                bindtap="onSelectSupervisionType"
              >
                <view class="radio-dot"></view>
                <text class="radio-text">{{item.name}}</text>
              </view>
            </view>
          </view>
          
          <view class="form-group">
            <view class="form-label">ç£å¯¼è´¹ç”¨</view>
            <view class="money-input">
              <text class="currency">Â¥</text>
              <input 
                type="digit" 
                class="money-input-field" 
                placeholder="0.00" 
                value="{{formData.supervisionFee}}"
                bindinput="onSupervisionFeeInput"
              />
            </view>
          </view>
        </view>
      </view>

      <!-- å’¨è¯¢è®°å½• -->
      <view class="form-section">
        <view class="section-header">
          <view class="section-title">å’¨è¯¢è®°å½•</view>
          <view class="section-optional">é€‰å¡«</view>
        </view>
        
        <!-- SOAPè®°å½•æ³• -->
        <view class="soap-form">
          <view class="soap-section">
            <view class="soap-label">
              <text class="label-text">ä¸»è§‚ (S)</text>
              <text class="label-desc">æ¥è®¿è€…ä¸»è¯‰ã€æ„Ÿå—</text>
            </view>
            <textarea 
              class="soap-textarea" 
              placeholder="è¯·è¾“å…¥æ¥è®¿è€…çš„ä¸»è§‚æè¿°..." 
              value="{{formData.subjective}}"
              bindinput="onSubjectiveInput"
              maxlength="1000"
            />
            <view class="textarea-counter">{{formData.subjective ? formData.subjective.length : 0}}/1000</view>
          </view>
          
          <view class="soap-section">
            <view class="soap-label">
              <text class="label-text">å®¢è§‚ (O)</text>
              <text class="label-desc">è§‚å¯Ÿåˆ°çš„å®¢è§‚äº‹å®</text>
            </view>
            <textarea 
              class="soap-textarea" 
              placeholder="è¯·è¾“å…¥å®¢è§‚è§‚å¯Ÿåˆ°çš„ä¿¡æ¯..." 
              value="{{formData.objective}}"
              bindinput="onObjectiveInput"
              maxlength="1000"
            />
            <view class="textarea-counter">{{formData.objective ? formData.objective.length : 0}}/1000</view>
          </view>
          
          <view class="soap-section">
            <view class="soap-label">
              <text class="label-text">è¯„ä¼° (A)</text>
              <text class="label-desc">ä¸“ä¸šè¯„ä¼°ä¸åˆ†æ</text>
            </view>
            <textarea 
              class="soap-textarea" 
              placeholder="è¯·è¾“å…¥æ‚¨çš„ä¸“ä¸šè¯„ä¼°..." 
              value="{{formData.assessment}}"
              bindinput="onAssessmentInput"
              maxlength="1000"
            />
            <view class="textarea-counter">{{formData.assessment ? formData.assessment.length : 0}}/1000</view>
          </view>
          
          <view class="soap-section">
            <view class="soap-label">
              <text class="label-text">è®¡åˆ’ (P)</text>
              <text class="label-desc">ä¸‹ä¸€æ­¥è®¡åˆ’ä¸å»ºè®®</text>
            </view>
            <textarea 
              class="soap-textarea" 
              placeholder="è¯·è¾“å…¥ä¸‹ä¸€æ­¥è®¡åˆ’..." 
              value="{{formData.plan}}"
              bindinput="onPlanInput"
              maxlength="1000"
            />
            <view class="textarea-counter">{{formData.plan ? formData.plan.length : 0}}/1000</view>
          </view>
        </view>
        
        <!-- å†…å®¹æ‘˜è¦ -->
        <view class="form-group">
          <view class="form-label">å†…å®¹æ‘˜è¦</view>
          <textarea 
            class="form-textarea" 
            placeholder="ç®€è¦æè¿°æœ¬æ¬¡å’¨è¯¢çš„ä¸»è¦å†…å®¹..." 
            value="{{formData.contentSummary}}"
            bindinput="onContentSummaryInput"
            maxlength="500"
          />
          <view class="textarea-counter">{{formData.contentSummary ? formData.contentSummary.length : 0}}/500</view>
        </view>
        
        <!-- ä½œä¸šä¸è®¡åˆ’ -->
        <view class="form-group">
          <view class="form-label">å®¶åº­ä½œä¸š</view>
          <textarea 
            class="form-textarea" 
            placeholder="æœ¬æ¬¡å¸ƒç½®çš„å®¶åº­ä½œä¸š..." 
            value="{{formData.homework}}"
            bindinput="onHomeworkInput"
            maxlength="500"
          />
          <view class="textarea-counter">{{formData.homework ? formData.homework.length : 0}}/500</view>
        </view>
        
        <view class="form-group">
          <view class="form-label">ä¸‹æ¬¡å’¨è¯¢è®¡åˆ’</view>
          <textarea 
            class="form-textarea" 
            placeholder="è®¡åˆ’ä¸‹æ¬¡å’¨è¯¢çš„å†…å®¹..." 
            value="{{formData.nextPlan}}"
            bindinput="onNextPlanInput"
            maxlength="500"
          />
          <view class="textarea-counter">{{formData.nextPlan ? formData.nextPlan.length : 0}}/500</view>
        </view>
      </view>

      <!-- é™„ä»¶ä¸Šä¼  -->
      <view class="form-section">
        <view class="section-header">
          <view class="section-title">é™„ä»¶ä¸Šä¼ </view>
          <view class="section-optional">é€‰å¡«</view>
        </view>
        
        <view class="attachments">
          <!-- å›¾ç‰‡é™„ä»¶ -->
          <view class="attachment-section">
            <view class="attachment-label">
              <text class="label-text">å›¾ç‰‡</text>
              <text class="label-tip">æœ€å¤š9å¼ </text>
            </view>
            <view class="image-list">
              <view 
                wx:for="{{imageAttachments}}" 
                wx:key="id" 
                class="image-item"
                data-index="{{index}}"
                bindtap="onPreviewImage"
              >
                <image class="image-preview" src="{{item.path}}" mode="aspectFill" />
                <view class="image-remove" catchtap="onRemoveImage" data-index="{{index}}">Ã—</view>
              </view>
              
              <view 
                wx:if="{{imageAttachments.length < 9}}" 
                class="upload-btn image-upload"
                bindtap="onAddImage"
              >
                <view class="upload-icon">+</view>
                <view class="upload-text">æ·»åŠ å›¾ç‰‡</view>
              </view>
            </view>
          </view>
          
          <!-- æ–‡ä»¶é™„ä»¶ -->
          <view class="attachment-section">
            <view class="attachment-label">
              <text class="label-text">æ–‡æ¡£</text>
              <text class="label-tip">æ”¯æŒpdf,doc,xlsç­‰</text>
            </view>
            <view class="file-list">
              <view 
                wx:for="{{fileAttachments}}" 
                wx:key="id" 
                class="file-item"
                data-index="{{index}}"
                bindtap="onPreviewFile"
              >
                <view class="file-icon">ğŸ“„</view>
                <view class="file-info">
                  <view class="file-name">{{item.name}}</view>
                  <view class="file-size">{{formatFileSize(item.size)}}</view>
                </view>
                <view class="file-remove" catchtap="onRemoveFile" data-index="{{index}}">Ã—</view>
              </view>
              
              <view 
                class="upload-btn file-upload"
                bindtap="onAddFile"
              >
                <view class="upload-icon">+</view>
                <view class="upload-text">æ·»åŠ æ–‡æ¡£</view>
              </view>
            </view>
          </view>
          
          <!-- éŸ³é¢‘é™„ä»¶ -->
          <view class="attachment-section">
            <view class="attachment-label">
              <text class="label-text">éŸ³é¢‘</text>
              <text class="label-tip">å’¨è¯¢å½•éŸ³ï¼ˆéœ€æ¥è®¿è€…åŒæ„ï¼‰</text>
            </view>
            <view class="audio-list">
              <view 
                wx:for="{{audioAttachments}}" 
                wx:key="id" 
                class="audio-item"
                data-index="{{index}}"
                bindtap="onPlayAudio"
              >
                <view class="audio-icon">ğŸµ</view>
                <view class="audio-info">
                  <view class="audio-name">{{item.name}}</view>
                  <view class="audio-duration">{{formatDuration(item.duration)}}</view>
                </view>
                <view class="audio-controls">
                  <view class="audio-remove" catchtap="onRemoveAudio" data-index="{{index}}">Ã—</view>
                </view>
              </view>
              
              <view 
                class="upload-btn audio-upload"
                bindtap="onAddAudio"
              >
                <view class="upload-icon">+</view>
                <view class="upload-text">æ·»åŠ éŸ³é¢‘</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- åŒæ­¥åˆ°æ—¥ç¨‹ -->
      <view class="form-section sync-section">
        <view class="sync-toggle">
          <view class="sync-label">
            <view class="sync-icon">ğŸ“…</view>
            <view class="sync-text">åŒæ­¥åˆ°æ—¥ç¨‹</view>
          </view>
          <switch checked="{{formData.syncToSchedule}}" bindchange="onSyncToggle" />
        </view>
        <view wx:if="{{formData.syncToSchedule}}" class="sync-options">
          <view class="form-group">
            <view class="form-label">æé†’æ—¶é—´</view>
            <view class="remind-options">
              <view 
                wx:for="{{remindOptions}}" 
                wx:key="value"
                class="remind-option {{formData.remindTime === item.value ? 'active' : ''}}"
                data-value="{{item.value}}"
                bindtap="onSelectRemindTime"
              >
                {{item.label}}
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨å ä½ -->
      <view class="bottom-spacer"></view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <view class="action-left">
      <view class="draft-btn" bindtap="onSaveDraft">ä¿å­˜è‰ç¨¿</view>
    </view>
    <view class="action-right">
      <view class="cancel-btn" bindtap="onCancel">å–æ¶ˆ</view>
      <view class="submit-btn {{isFormValid ? '' : 'disabled'}}" bindtap="onSubmit">
        {{isEditMode ? 'æ›´æ–°è®°å½•' : 'ä¿å­˜è®°å½•'}}
      </view>
    </view>
  </view>

  <!-- åŠ è½½é®ç½© -->
  <view wx:if="{{loading}}" class="loading-mask">
    <view class="loading-content">
      <view class="loading-icon"></view>
      <view class="loading-text">ä¿å­˜ä¸­...</view>
    </view>
  </view>
</view>